{% extends 'base/main.html' %}
{% load static %}
{% block head %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'manage.css' %}">
{% endblock %}
{% block content %}
<div class="dashboard-container">

    <div class="bento-card welcome">
        <h2><i class="fas fa-users-cog"></i> User Management</h2>
        <p>Manage user accounts, roles, and system permissions.</p>
    </div>


    {% if messages %}
    <div class="bento-card messages">
        <h3><i class="fas fa-info-circle"></i> System Messages</h3>
        <div class="messages-list">
            {% for message in messages %}
            <div class="message-item{% if message.tags %} {{ message.tags }}{% endif %}">
                <i class="fas fa-{% if message.tags == 'success' %}check-circle{% elif message.tags == 'error' %}exclamation-triangle{% else %}info-circle{% endif %}"></i>
                {{ message }}
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    {% if mfa_required %}

    <div class="bento-card security">
        <h3><i class="fas fa-shield-alt"></i> MFA Verification Required</h3>
        <p class="security-notice">Please verify your identity with MFA to access user management features.</p>
        <form method="post" class="mfa-form">
            {% csrf_token %}
            <div class="form-group">
                <label for="mfa_code"><i class="fas fa-key"></i> Enter your MFA code:</label>
                <input type="text" name="mfa_code" id="mfa_code" required class="mfa-input">
            </div>
            <button type="submit" class="verify-btn">
                <i class="fas fa-check"></i> Verify MFA
            </button>
        </form>
    </div>
    {% else %}

    <div class="bento-card pending">
        <h3><i class="fas fa-clock"></i> Pending Users ({{ pending|length }})</h3>
        {% if pending %}
        <div class="users-list">
            {% for lizard in pending %}
            <div class="user-item pending-user">
                <div class="user-info">
                    <div class="user-avatar">
                        <i class="fas fa-user-clock"></i>
                    </div>
                    <div class="user-details">
                        <div class="user-name">{{ lizard.user.username }}</div>
                        <div class="user-role">{{ lizard.role|title }}</div>
                    </div>
                </div>
                <div class="user-actions">
                    <form method="post" class="action-form">
                        {% csrf_token %}
                        <input type="hidden" name="lizard_id" value="{{ lizard.id }}">
                        <input type="hidden" name="action" value="approve">
                        <button type="submit" class="approve-btn">
                            <i class="fas fa-check"></i> Approve
                        </button>
                    </form>
                    <form method="post" class="action-form">
                        {% csrf_token %}
                        <input type="hidden" name="lizard_id" value="{{ lizard.id }}">
                        <input type="hidden" name="action" value="revoke">
                        <button type="submit" class="revoke-btn">
                            <i class="fas fa-times"></i> Revoke
                        </button>
                    </form>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
            <div class="empty-state">
                <i class="fas fa-check-circle"></i>
                <p>No pending users.</p>
                <p class="empty-subtitle">All user registrations have been processed.</p>
            </div>
        {% endif %}
    </div>


    <div class="bento-card users">
        <h3><i class="fas fa-users"></i> All Users ({{ users|length }})</h3>
        {% if users %}
        <div class="users-list">
            {% for lizard in users %}
            <div class="user-item">
                <div class="user-info">
                    <div class="user-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="user-details">
                        <div class="user-name">{{ lizard.user.username }}</div>
                        <div class="user-role">{{ lizard.role|title }}</div>
                        <div class="user-status">
                            {% if lizard.user.is_active %}
                                <span class="status active"><i class="fas fa-circle"></i> Active</span>
                            {% else %}
                                <span class="status inactive"><i class="fas fa-circle"></i> Inactive</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="user-actions">
                    <form method="post" class="role-form">
                        {% csrf_token %}
                        <input type="hidden" name="lizard_id" value="{{ lizard.id }}">
                        <input type="hidden" name="action" value="role">
                        <div class="role-selector">
                            <select name="role" class="role-select">
                                {% for key, value in lizard.ROLE_CHOICES %}
                                <option value="{{ key }}" {% if lizard.role == key %}selected{% endif %}>{{ value }}</option>
                                {% endfor %}
                            </select>
                            <button type="submit" class="update-role-btn">
                                <i class="fas fa-save"></i> Update
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
            <div class="empty-state">
                <i class="fas fa-users"></i>
                <p>No users found.</p>
                <p class="empty-subtitle">User accounts will appear here once registered.</p>
            </div>
        {% endif %}
    </div>
    {% endif %}
</div>
{% endblock %}
