{% extends 'base/main.html' %}
{% load static %}
{% block head %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'images.css' %}">
{% endblock %}
{% block content %}
<div class="dashboard-container">

    <div class="bento-card welcome">
        <h2><i class="fas fa-images"></i> Image Management</h2>
        <p>Upload, view, and manage your image files securely.</p>
    </div>


    {% if error %}
    <div class="bento-card security">
        <h3><i class="fas fa-exclamation-triangle"></i> Error</h3>
        <div style="color: #d32f2f; padding: 1em; background: rgba(211, 47, 47, 0.1); border-radius: 10px;">
            {{ error }}
        </div>
    </div>
    {% endif %}


    {% if 'create' in user_permissions.images %}
    <div class="bento-card quick-actions">
        <h3><i class="fas fa-upload"></i> Upload New Image</h3>
        <form method="post" enctype="multipart/form-data" style="margin-top: 1em;">
            {% csrf_token %}
            <input type="hidden" name="action" value="create">
            <div style="display: grid; gap: 1em;">
                <div>
                    <label for="name" style="display: block; margin-bottom: 0.5em; font-weight: 600; color: #379634;">Image Name:</label>
                    <input type="text" name="name" id="name" required style="width: 100%; padding: 0.8em; border: 2px solid #379634; border-radius: 8px; background: rgba(255, 255, 255, 0.9);">
                </div>
                <div>
                    <label for="file" style="display: block; margin-bottom: 0.5em; font-weight: 600; color: #379634;">Select Image File:</label>
                    <input type="file" name="file" accept="image/*" required style="width: 100%; padding: 0.8em; border: 2px solid #379634; border-radius: 8px; background: rgba(255, 255, 255, 0.9);">
                </div>
                <button type="submit" style="background: linear-gradient(135deg, #379634, #5cdb95); color: white; border: none; padding: 1em 2em; border-radius: 25px; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
                    <i class="fas fa-upload"></i> Upload Image
                </button>
            </div>
        </form>
    </div>
    {% endif %}


    <div class="bento-card stats">
        <h3><i class="fas fa-list"></i> Your Images ({{ files|length }})</h3>
        {% if files %}
            <div class="image-grid">
                {% for img in files %}
                <div class="image-card">
                    <div style="text-align: center; margin-bottom: 0.5em;">
                        {% if 'read' in user_permissions.images %}
                            <img src="{% url 'serve_image' img.id %}" alt="{{ img.name }}"
                                 class="image-thumbnail"
                                 onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                            <div style="display:none; color:#d32f2f; font-style:italic; padding: 1em; background: rgba(211, 47, 47, 0.1); border-radius: 8px; margin: 0.5em 0;">
                                <i class="fas fa-exclamation-triangle"></i> Failed to load
                            </div>
                        {% endif %}
                    </div>

                    <div class="image-info">
                        <h4>{{ img.name }}</h4>
                    </div>

                    <div class="image-meta">
                        <div><i class="fas fa-calendar"></i> {{ img.uploaded_at|date:"M j" }}</div>
                        <div><i class="fas fa-weight"></i> {{ img.size }}</div>
                    </div>

                    <div class="image-actions">
                        {% if 'read' in user_permissions.images %}
                            <a href="{% url 'image_preview' img.id %}" style="text-decoration: none;">
                                <button type="button" class="view-btn">
                                    <i class="fas fa-eye"></i> View
                                </button>
                            </a>
                        {% endif %}

                        {% if 'write' in user_permissions.images %}
                        <form method="post" enctype="multipart/form-data" style="display: inline;">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="write">
                            <input type="hidden" name="id" value="{{ img.id }}">
                            <input type="file" name="file" accept="image/*" required style="display: none;" id="replace-file-{{ img.id }}">
                            <button type="button" onclick="document.getElementById('replace-file-{{ img.id }}').click()"
                                    class="replace-btn">
                                <i class="fas fa-edit"></i> Replace
                            </button>
                            <button type="submit" style="display: none;" id="submit-replace-{{ img.id }}"></button>
                        </form>
                        {% endif %}

                        {% if 'delete' in user_permissions.images %}
                        <form method="post" style="display: inline;">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="delete">
                            <input type="hidden" name="id" value="{{ img.id }}">
                            <button type="submit" onclick="return confirm('Are you sure you want to delete this image?')"
                                    class="delete-btn">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </form>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <div style="text-align: center; padding: 3em; color: #666; background: rgba(255, 255, 255, 0.5); border-radius: 15px; margin-top: 1em;">
                <i class="fas fa-images" style="font-size: 3em; color: #ccc; margin-bottom: 1em;"></i>
                <p>No images uploaded yet.</p>
                {% if 'create' in user_permissions.images %}
                    <p style="font-size: 0.9em;">Upload your first image using the form above!</p>
                {% endif %}
            </div>
        {% endif %}
    </div>
</div>

<script>

document.addEventListener('change', function(e) {
    if (e.target.matches('input[type="file"][id^="replace-file-"]')) {
        const fileInput = e.target;
        const form = fileInput.closest('form');
        if (fileInput.files.length > 0) {
            form.querySelector('button[type="submit"]').click();
        }
    }
});
</script>
{% endblock %}
