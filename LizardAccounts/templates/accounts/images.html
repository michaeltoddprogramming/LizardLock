{% extends 'accounts/main.html' %}
{% block content %}
<h2>Images</h2>
{% if error %}
    <div style="color:red;">{{ error }}</div>
{% endif %}

<!-- Upload Form (only if user can create) -->
{% if 'create' in user_permissions.images %}
<form method="post" enctype="multipart/form-data">
    {% csrf_token %}
    <input type="hidden" name="action" value="create">
    <label for="name">Image Name:</label>
    <input type="text" name="name" id="name" required>
    <input type="file" name="file" accept="image/*" required>
    <button type="submit">Upload Image</button>
</form>
<hr>
{% endif %}

<ul>
    {% for img in files %}
        <li>
            <b>{{ img.name }}</b> ({{ img.size }} bytes, uploaded {{ img.uploaded_at|date:"Y-m-d H:i" }})
            <br>by {{ img.owner }}
            <br>
            
            <!-- Show image if user can read -->
            {% if 'read' in user_permissions.images %}
                <img src="{% url 'serve_image' img.id %}" alt="{{ img.name }}" width="150" 
                     onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                <div style="display:none; color:red; font-style:italic;">Image failed to load</div>
                <br>
                
                <!-- View/Download -->
                <a href="{% url 'image_preview' img.id %}">
                    <button type="button">View</button>
                </a>
            {% endif %}
            
            <!-- Delete (only if user has delete permission) -->
            {% if 'delete' in user_permissions.images %}
            <form method="post" style="display:inline;">
                {% csrf_token %}
                <input type="hidden" name="action" value="delete">
                <input type="hidden" name="id" value="{{ img.id }}">
                <button type="submit" onclick="return confirm('Delete this image?')">Delete</button>
            </form>
            {% endif %}
            
            <!-- Edit/Replace (only if user has write permission) -->
            {% if 'write' in user_permissions.images %}
            <form method="post" enctype="multipart/form-data" style="display:inline;">
                {% csrf_token %}
                <input type="hidden" name="action" value="write">
                <input type="hidden" name="id" value="{{ img.id }}">
                <input type="file" name="file" accept="image/*" required>
                <button type="submit">Replace</button>
            </form>
            {% endif %}
        </li>
    {% empty %}
        <li>No images uploaded.</li>
    {% endfor %}
</ul>
{% endblock %}